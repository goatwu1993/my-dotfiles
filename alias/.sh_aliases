#!/bin/bash

dbash() { docker exec -it $@ bash ;}
grep_cve() { grep -oE 'CVE-[0-9]*-[0-9]*' }
dsh()  { docker exec -it $@ sh ;}
dlog()  { docker logs --tail=all -f $@ ;}
kbash() { kubectl exec -it $@ -- bash ;}
lares_access_token()
{
    export LARES_ACCESS_TOKEN="$@"
}

function urldecode() { : "${*//+/ }"; echo -e "${_//%/\\x}"; }

function urlencode() {
    local string="${1// /+}"
    printf '%s' "$string" | jq -sRr @uri
}

gh_run_view_detailed()
{
    gh run view $@ --log-failed
}

touch_init_py()
{
    touch $1/__init__.py;
}

release-please-commit()
{
    git commit -m "chore: release $@" -m "Release-As: $@" --allow-empty
}

jwt_payload()
{
    cat | jq -R 'split(".") | .[1] | @base64d | fromjson'
}

git_sha()
{
    git rev-parse HEAD
}

refactor() {
    if [ $# -ne 2 ]; then
        echo "Usage: replace_strings <old_string> <new_string>"
        return 1
    fi

    old_string=$1
    new_string=$2

    # Use ripgrep (rg) to search for files containing the old string
    sd "$old_string" "$new_string" $(rg -l "$old_string")
}

osv_purl() {
    if [ $# -ne 1 ]; then
        echo "Usage: osv_purl <purl>"
        return 1
    fi

    purl=$1
    curl -s "https://osv-vulnerabilities.storage.googleapis.com/v1/query?package=$purl" | jq '.'
    curl -X POST https://api.osv.dev/v1/query -d "{\"package\": {\"purl\": \"$1\"}}" | jq
}

osv_cve() {
    if [ $# -ne 1 ]; then
        echo "Usage: osv_cve <cve_id>"
        return 1
    fi

    cve_id=$1
    curl -s "https://api.osv.dev/v1/vulns/$1" | jq '.'
}

radar_cve_search() {
    if [ $# -ne 1 ]; then
        echo "Usage: radar_cve_search <cve_id>"
        return 1
    fi

    cve_id=$1
    curl -X POST https://radar.rdsec.trendmicro.com/api/v1/artifacts/vulnerabilities -H "Content-Type: application/json" -d '{"filters": {"vulnId": "'"$cve_id"'"}, "pagination": {"limit": 100}}' | jq '.data'
}

radar_artifact_vulns() {
    if [ $# -ne 1 ]; then
        echo "Usage: radar_cve_search <cve_id>"
        return 1
    fi

    cve_id=$1
    curl https://radar.rdsec.trendmicro.com/api/v1/artifacts/${cve_id}/vulnerabilities | jq '.data'
}



grypeserver_purl() {
    if [ $# -ne 1 ]; then
        echo "Usage: grypeserver_purl <purl>"
        return 1
    fi

    purl=$1
    curl -X POST http://localhost:8003/api/v1/grype -d '{"purl": "'"$purl"'"}' | jq '.matches'
}

grypeserver_cpe() {
    if [ $# -ne 1 ]; then
        echo "Usage: grypeserver_cpe <cpe>"
        return 1
    fi

    cpe=$1
    curl -X POST http://localhost:8003/api/v1/grype -d '{"cpe": "'"$cpe"'"}' | jq '.matches'
}


#alias vim="nvim"
alias fy="fuck -y"
alias gs="git status"
alias ll="ls -lAh"
#alias tree="tree -I 'node_modules|cache|test_*|.git'"
alias gbp="git fetch --prune"
alias hgrep="history | grep"
alias aws-docker-login='aws ecr get-login-password --region $(aws configure get region) |  docker login --username AWS --password-stdin $(aws sts get-caller-identity --query Account --output text).dkr.ecr.$(aws configure get region).amazonaws.com'

alias copysshpub='cat ~/.ssh/id_rsa.pub | pbcopy'
alias v="nvim"
alias vm="nvim"
alias vi="nvim"
alias vmi="nvim"
alias vim="nvim"
alias vum="nvim"
alias vun="nvim"
alias acsr="aws configure set region"
alias yb="yarn build"
alias gfp="git fetch --prune"
alias ghprvw="gh pr view -w"
alias m="make"
alias prvw="gh pr view -w"
alias setadcsshkey="gh ssh-key add ~/.ssh/id_rsa.pub -t peter_mbpr"
alias peotry="poetry"
# cat ~/.ssh/id_rsa.pub | pbcopy
# easy copy ssh key
alias copy_ssh_public_key="cat ~/.ssh/id_rsa.pub | pbcopy"
alias npx="npm exec"
alias gitroot="git rev-parse --show-toplevel"
alias docker-compose="docker compose"
alias docekr="docker"

git-make() {
    make -C $(git rev-parse --show-toplevel) $@
}

curl_json() {
    curl -H "Content-Type: application/json" $@
}

alias altas="atlas"

grbp() {
    git fetch && git rebase && git push --force-with-lease
}

# takes one argument: the path to the git worktree
gitworktreecd() {
    worktree_name=$1
    #git worktree list | grep "\[${WORKTREE_NAME}\]" | awk '{print $1}'
    cd $(git worktree list | grep "\[${worktree_name}\]" | awk '{print $1}')
}

alias gprmads="gh pr merge --admin -d -s"
alias tree='tree -I ".venv|node_modules|.git|__pycache__"'
alias biomemigrate='npx @biomejs/biome migrate -- --write'
alias ktp="kubectl top pod"
